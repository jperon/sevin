\usepackage{fontspec}
\usepackage{libertine}
\usepackage{babel}
%\usepackage{polyglossia}\setmainlanguage{french}
\usepackage{makeidx}
\setcounter{tocdepth}{3}
\usepackage[includeheadfoot,inner=7mm,outer=12mm,top=5mm,bottom=8mm,headsep=3mm,footskip=5mm]{geometry}
\usepackage{needspace}
\usepackage{ifthen}
\usepackage{keycommand}
\usepackage{calc}
\usepackage{multicol}
\frenchbsetup{og=«,fg=»}
\usepackage[pdftex=true,%
    hypertexnames=false,%
    bookmarks=true,%
    bookmarksopen=true%
    pdfborder=0,%
    hyperindex=true,%
    pdfpagelabels=true,%
    unicode%
    ]{hyperref}

\widowpenalty=10000 \clubpenalty=10000

\def\preLilyPondExample{\widowpenalty=0 \clubpenalty=0}
\def\postLilyPondExample{\par\widowpenalty=10000 \clubpenalty=10000\par}

\catcode`\ =\active
\def  { }
\catcode`\’=\active
\def ’{'}

\parindent=0pt

\let\oldaddcontentsline\addcontentsline

\renewcommand{\addcontentsline}{%
    \phantomsection
    \oldaddcontentsline%
}

\newcounter{chant}
\setcounter{chant}{0}
\newcounter{numerocouplet}
\newlength{\decalage}

\newkeycommand{\chanson}[position=centre,decalage=3cm,premiercouplet=1,numero=2][1]{%
  \vspace*{1em plus .2ex minus .2ex}

  \needspace{\baselineskip}
  \setcounter{numerocouplet}{\commandkey{numero}-1}
  \ifthenelse{\equal{\commandkey{position}}{2col}}{%
    \begin{multicols}{2}
    \raggedcolumns
    {\input{#1}}
    \end{multicols}%
  }{%
    {\input{#1}}%
  }
}
\newcommand{\couplet}[1]{%
  \stepcounter{numerocouplet}%
  \ifthenelse{%
    \commandkey{premiercouplet} = \value{numerocouplet}%
    \OR \commandkey{premiercouplet} < \value{numerocouplet}%
  }{%
    \ifthenelse{\equal{\commandkey{position}}{centre}}{%
      {%
	 {\vspace{0ex plus 2\baselineskip minus .5\baselineskip}
	 \widowpenalty=10000 \clubpenalty=10000\par
  	 \centering\arabic{numerocouplet}.~#1\par}
  	 \vspace{2ex minus 1ex}
       }%
    }{%
      \setlength{\decalage}{\linewidth - \commandkey{decalage}}%
      \hspace{\commandkey{decalage}}%
      \pagebreak[3]\parbox{\decalage}{%
    	\raggedright%
	\parindent=-\commandkey{decalage}%
	\arabic{numerocouplet}.~#1\par
	\vspace*{2ex}
      }%
    }
  }{}
}

\newcommand{\refrain}[1]{%
	\ifthenelse{\equal{\commandkey{position}}{centre}}{{%
	  \parbox{\linewidth}{%
	  	\centering
  	  \itshape #1\par
  	  \vspace{2ex}
  	}}%
  	}{%
		\setlength{\decalage}{\linewidth - \commandkey{decalage}}%
    \hspace{\commandkey{decalage}}%
    \pagebreak[3]\parbox{\decalage}{%
    		\raggedright%
			\parindent=-\commandkey{decalage}%
	  	\itshape #1\par
	  	\vspace*{2ex}
   	}%
  }

}

\newcommand{\coupletvide}[1]{%
  \parbox{\linewidth}{%
    \vspace{#1\baselineskip}%
  }
}

\newcommand{\titre}[2]{%
	\vspace{1em plus 6\baselineskip}\needspace{6\baselineskip}
	\stepcounter{chant}
	\index{#2}
	\addcontentsline{toc}{subsubsection}{#2}
	{\centering\textbf{\large \arabic{chant}.~#1}\par}
	\vspace{1ex plus .7ex minus .2ex}
}

\newcommand{\soustitre}[1]{%
	\needspace{5\baselineskip}
	{\centering\textsc{#1}\par}
}

\newcommand{\partie}[1]{%
	\cleardoublepage
	\vspace*{\stretch{1}}
	{\centering\textbf{\Huge #1}\par}
	\addcontentsline{toc}{section}{#1}
	\vspace*{\stretch{2}}
	\thispagestyle{empty}
	\clearpage
}

\newcommand{\souspartie}[1]{%
	\clearpage
	{\centering\textbf{\LARGE #1}\par}
	\addcontentsline{toc}{subsection}{#1}
}

\makeindex
